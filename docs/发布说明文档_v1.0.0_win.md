# BookStore Windows 发布说明

## 版本信息
- 应用名称：BookStore
- 安装包：`installer/BookStore-Setup.exe`
- Qt 运行库：Qt 6.10.1 (MinGW)
- 编译工具链：MinGW-w64 13.1 + Ninja（随安装包一并部署运行时 DLL）
- 支持平台：Windows 10/11 x64

## 面向用户的安装指南
### 下载
下载 `installer.zip` 并解压即可。

### 安装
1. 双击运行 `BookStore-Setup.exe`。
2. 选择安装目录（默认：`C:\Program Files\BookStore`）。
3. 完成安装后，在开始菜单和桌面会生成快捷方式“BookStore”。

说明：安装器已内置 Qt 依赖与插件（`Qt6Core/Gui/Widgets/Network/Svg`、`platforms/qwindows.dll`、`imageformats/*`、`styles/*` 等），无需额外配置环境变量。

### 运行与数据位置
- 通过“开始菜单/桌面快捷方式”启动应用。
- 应用的工作目录（读写数据文件）为：`%LOCALAPPDATA%\BookStore`。
  - 默认数据文件：`finance.dat`、`employee.dat`、`log.dat` 等。
  - 此目录在安装时自动创建，卸载时默认保留（避免误删用户数据）。

### 卸载
- 通过“设置 → 应用 → 已安装的应用（或 控制面板 → 程序和功能）”卸载 BookStore，或执行安装目录下的 `Uninstall.exe`。
- 卸载不会删除 `%LOCALAPPDATA%\BookStore` 用户数据目录，如需彻底清理，可手动删除该目录。

## 常见问题与排查
- 启动提示缺少 Qt DLL（如 `Qt6Core.dll`）：
  - 请确保通过安装器安装，或在“便携运行”模式下已执行 `windeployqt`（见下文开发与打包）。
- 启动无响应/闪退：
  - 从命令行运行 `BookStore.exe` 观察输出；检查杀毒软件是否拦截。
- DPI 缩放异常（界面过大/过小）：
  - 可设置环境变量 `QT_AUTO_SCREEN_SCALE_FACTOR=1`，或在“显示设置”调整缩放比例后重启应用。
- DirectX 相关警告（`dxcompiler.dll/dxil.dll`）：
  - 为可选组件，缺失不影响本应用的基本功能，可忽略。
- 建议在系统的浅色模式下运行；该程序暂不支持深色模式，在该模式下运行可能出现文字颜色较暗，难以阅读的情况。

## 便携运行（可选）
需要下载 `build-qt.zip` 并解压。

无需安装可直接运行：
1. 将 `build-qt/` 目录与其中 DLL、`platforms/`、`imageformats/` 等插件文件夹整体打包复制。
2. 在该目录内直接运行 `BookStore.exe` 即可。

## 给开发/发行者：构建与打包流程
### 1. 配置与构建（Ninja + Qt MinGW）
```powershell
# 以当前仓库根目录为例
$env:PATH = "C:\Qt\Tools\mingw1310_64\bin;C:\Qt\6.10.1\mingw_64\bin;" + $env:PATH
cmake -S . -B build-qt -G "Ninja" `
  -DCMAKE_C_COMPILER="C:/Qt/Tools/mingw1310_64/bin/gcc.exe" `
  -DCMAKE_CXX_COMPILER="C:/Qt/Tools/mingw1310_64/bin/g++.exe" `
  -DCMAKE_PREFIX_PATH="C:/Qt/6.10.1/mingw_64/lib/cmake"
cmake --build build-qt --config Release
```

### 2. 部署 Qt 运行时（windeployqt）
```powershell
$env:PATH = "C:\Qt\6.10.1\mingw_64\bin;" + $env:PATH
cd build-qt
windeployqt.exe BookStore.exe
```
这一步会拷贝 Qt6 所需 DLL 与插件到 `build-qt/`。

### 3. 生成安装器（NSIS）
脚本位置：`installer/BookStore.nsi`
```powershell
& "C:\Program Files (x86)\NSIS\Bin\makensis.exe" installer/BookStore.nsi
```
输出产物：`installer/BookStore-Setup.exe`

### 4. 验证
- 在干净的 Windows 虚拟机或容器中运行安装包，确认可安装、可启动、可读写数据。
- 重点检查：`%LOCALAPPDATA%\BookStore` 是否正常创建与读写。

## 变更摘要
- 新增 Windows 安装器（NSIS）。
- 安装快捷方式的工作目录指向 `%LOCALAPPDATA%\BookStore`，避免 `Program Files` 写权限问题。
- 打包集成 Qt 依赖与插件，无需用户安装 Qt。
- 这一发布对应的代码包含有bug；如在编译时出现问题，请下载最新代码包，或者在 `log.hpp` 中加入 `#include <iomanip>` 指令，应该可以解决。
