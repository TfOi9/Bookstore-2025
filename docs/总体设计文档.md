# BookStore 总体设计文档

项目名称：BookStore（书店管理系统）    
文档作者：TfOi9    
修订记录：2025-12-15 修订

## 程序功能概述

本程序为一个基于命令行的书店管理系统，使用 C++ 实现，面向店长、员工与顾客提供图书检索与购买服务，支持账号注册、登录、注销、图书查询、购买；对员工提供选择并修改图书信息与进货；对店长提供财务查询、员工工作报表与系统操作日志查看等。系统采用文件持久化存储，首次运行时自动创建 `root` 账户。系统支持嵌套登录，指令以当前栈顶用户身份执行。默认游客（未登录）仅可注册和登录。另有 GUI 子项目正在开发，见 [frontend/](../frontend) 目录。

## 主体逻辑说明

系统以“指令解析 → 参数验证 → 权限校验 → 执行模块 → 输出/日志”的流水线组织。核心运行流程：

- 读入一行命令，按空格分词；
- 根据首词选择命令分支（账号/图书/日志/系统）；
- 使用 `Validator` 检查参数格式与合法性；
- `AccountManager` 校验当前用户的权限；
- 调用 `AccountManager`/`BookManager`/`LogManager` 完成业务；
- 输出结果并记录操作日志、必要时记录财务日志。

权限模型（与代码一致）：
- 0：游客；1：顾客；3：员工/管理员；7：店长（root）。
- 高权限用户可在空密码时切换为低权限用户（降权登录），对应 `su user_id`。

## 代码文件结构

核心源码位于 [include/](../include) 与 [src/](../src)：

- 存储层：
  - [include/memory_river.hpp](../include/memory_river.hpp)：线性文件存储模板 `MemoryRiver<T>`；
  - [include/hash_map.hpp](../include/hash_map.hpp)：基于文件的哈希表模板 `HashMap<Key, Val>`，底层使用 `HashMemoryRiver<Bucket, Block>` 实现桶与块共文件存储；
- 账户模块：
  - [include/account.hpp](../include/account.hpp) / [src/account.cpp](../src/account.cpp)：`Account` 与 `AccountManager`；
- 图书模块：
  - [include/book.hpp](../include/book.hpp) / [src/book.cpp](../src/book.cpp)：`Book` 与 `BookManager`；
- 日志模块：
  - [include/log.hpp](../include/log.hpp) / [src/log.cpp](../src/log.cpp)：`FinanceLog`、`EmployeeLog`、`Log` 与 `LogManager`；
- 校验与工具：
  - [include/validator.hpp](../include/validator.hpp) / [src/validator.cpp](../src/validator.cpp)：参数格式校验；
  - [include/utils.hpp](../include/utils.hpp) / [src/utils.cpp](../src/utils.cpp)：时间、分词、数值安全解析与字符串/数组转换；
- 主程序：
  - [src/code.cpp](../src/code.cpp)：命令行解析与调度，创建各管理器实例并按权限分发命令。

运行时依赖关系（简图）：

AccountManager ↔ HashMap（account.dat）  
BookManager ↔ MemoryRiver（book.dat） + 多索引 HashMap（ISBN/书名/作者/关键词）  
LogManager ↔ MemoryRiver + HashMap     
Validator/Utils 为横切工具，供主程序与各模块调用。

## 功能设计

- 文件读写系统：
  - `MemoryRiver<T>`：线性追加与随机读/更新，头部保存信息区（大小等）；
  - `HashMemoryRiver<Bucket, Block>`：同文件内存储固定大小桶区与变长块区；
  - `HashMap<Key, Val>`：按哈希桶挂块状链表，支持插入、删除、查询、计数、序列化；
- 账户系统：
  - `Account`：`user_id`/`username`/`password`/`privilege` 四字段；
  - `AccountManager`：登录栈与选书栈；注册、登录/注销、改密、增删用户、选书、序列化与管理员列表；
- 图书系统：
  - `Book`：ISBN/书名/作者/关键词/价格/库存/ID；支持输出与比较；
  - `BookManager`：按 ID 线性存储；四类倒排索引（ISBN/书名/作者/关键词）；查询、序列化、修改 ISBN/书名/作者/关键词/价格、进货与购买、导出 CSV；
- 日志系统：
  - `FinanceLog`：编号、金额（正收入/负支出）、时间；
  - `EmployeeLog`：员工 `user_id` 与文本；
  - `Log`：普通操作日志文本；
  - `LogManager`：写财务/员工/操作日志，财务统计与报表、员工报表、日志打印；
- 验证模块：
  - `Validator`：链式校验最大/最小长度、可见字符、字母数字下划线、仅数字与小数点、仅一个点、禁用引号与竖线；
- 工具模块：
  - 时间戳、命令分词、参数解析（字符串/数值）、安全 `stoi`/`stod`、数组与字符串互转。

## 数据库设计

所有数据持久化存储于工作目录下，以二进制文件组织：

- 账户数据：
  - 主存：`account.dat`（HashMap，键：长度 30 的字符数组，值：`Account`）；
  - 记录结构：`Account{char[30] user_id, char[30] username, char[30] password, int privilege}`；
  - 初始化：程序首次运行自动插入 `root`（权限 7，默认密码 `sjtu`）。
- 图书数据：
  - 主存：`book.dat`（`MemoryRiver<Book>`，按 `id` 线性存储）；
  - 索引：`ISBN.dat`（ISBN→id）、`book_name.dat`（书名→id）、`author.dat`（作者→id）、`keyword.dat`（关键词→id），均为 `HashMap`；
  - 关键词解析：以 `|` 分隔的去重关键词集合，存储为多条索引记录。
- 日志数据：
  - 财务：`finance.dat`（`MemoryRiver<FinanceLog>`，顺序编号）；
  - 员工：`employee.dat`（`HashMap<char[30], EmployeeLog>`，按员工聚合查询）；
  - 操作：`log.dat`（`MemoryRiver<Log>`）。

文件头信息区由 `MemoryRiver`/`HashMemoryRiver` 维护当前大小与偏移，关闭析构时写回。

## 类与结构体设计

- `Account`（[include/account.hpp](../include/account.hpp)）：
  - 字段：`char[30] user_id, username, password; int privilege`；
  - 功能：`verify_password()`、只读访问器、`operator==`。
- `AccountManager`：
  - 数据：`HashMap<char[30], Account> account_file; int account_count; vector<Account> login_stack; vector<int> book_stack`；
  - 功能：`login/logout/register_account/change_password/add_account/delete_account/select_book/current_*()/selected_book()/list_admins()/serialize()`。
- `Book`（[include/book.hpp](../include/book.hpp)）：
  - 字段：`char[20] ISBN; char[60] name, author, keyword; double price; int quant, id`；
  - 功能：只读访问、比较、流输出。
- `BookManager`：
  - 数据：四类 `HashMap` 索引 + `MemoryRiver<Book>` 主存；
  - 功能：按索引/ID 查询、序列化、增书、修改各字段、进货与购买、导出。
- `FinanceLog`/`EmployeeLog`/`Log` 与 `LogManager`（[include/log.hpp](../include/log.hpp)）：
  - 功能：添加日志、财务汇总/统计、员工报表、打印操作日志。
- `Validator`（[include/validator.hpp](../include/validator.hpp)）：
  - 功能：链式校验器，支持多约束组合。
- `MemoryRiver`/`HashMap`（[include/memory_river.hpp](../include/memory_river.hpp)，[include/hash_map.hpp](../include/hash_map.hpp)）：
  - 功能：二进制文件持久化的线性存储与哈希桶-块结构索引。

## 其他补充说明

- 命令行接口由 [src/code.cpp](../src/code.cpp) 实现，支持命令：`su`、`logout`、`register`、`passwd`、`useradd`、`delete`、`show`（含 `show finance`）、`buy`、`select`、`modify`、`import`、`report`（`finance`/`employee`）、`log`、`quit/exit`。详细交互格式与输出请参考需求文档与评测数据。
- 权限与嵌套登录：登录栈顶用户决定权限；店长可空密码代入低权限用户执行，所有操作均写入普通日志，部分管理操作写入员工日志与财务日志。
- GUI：项目含 [frontend/](frontend) 目录，基于 Qt 规划图形界面，当前主体评测以 CLI 为准。
- 编译与评测：项目使用 CMake 构建；项目共包含三个可执行文件，其中，
`code` 为 CLI 版程序，`gui` 为用户界面，`cleanup` 为存储文件清理工具。
