# BookStore 总体设计文档

## 程序功能概述

本程序为一个基于命令行的书店管理系统，使用 C++ 实现。具体地，本程序为书店店长、员工和顾客服务，支持账号注册、登录、注销功能、图书查询、购买功能。对于员工，还提供修改图书信息、进货、账户管理功能；对于店长，还提供查看书店日志、管理财务情况等功能。

本程序使用文件存储，将账户、图书与日志信息保存在外存上。首次运行时，本程序将会自动创建店长账号。本程序支持嵌套登录，指令视为最后一个登录人员的操作。程序开始运行或没有账号登录时，视为游客账号，只能进行注册或登录操作。

计划实现图形用户界面。

## 程序逻辑概述

本程序采用面向对象编程，包含以下模块：

- 文件读写系统
- 账户及其管理系统
- 书籍及其管理系统
- 日志及其管理系统
- 字符串验证模块
- 指令解析模块
- 主程序

运行时，指令解析器解析指令，按要求把指令分发到账户 / 书籍 / 日志管理系统，通过文件读写完成指令，进行输出。

## 代码文件结构

1. `memory_river.hpp`

    实现了基本的线性文件读写类，包含文件随机读取、更新、写入功能。

2. `hash_map.hpp`

    实现了文件存储的哈希表模板类，支持修改键值类型、值类型、哈希函数、哈希桶规模等，包含插入、删除、查询键值对等功能。

3. `account.hpp`, `account.cpp`

    实现了账户类型，用于存储账户信息，提供了验证与修改密码、查询权限功能。

    实现了账户管理系统，包含注册、修改、查找、删除账户功能。

4. `book.hpp`, `book.cpp`

    实现了图书类型，用于存储图书信息。

    实现了图书管理系统，包含选择、查询、修改、购买、进货图书功能。

5. `log.hpp`, `log.cpp`

    实现了日志类型，包含财务日志、员工日志和操作日志三类，分别保存系统收支情况、员工工作记录和所有操作的日志。

    实现了日志管理系统，包含写入日志、查询财务情况、生成财务报表、生成员工工作表、查询日志等功能。

6. `validator.hpp`, `validator.cpp`

    实现了字符串判断类，包含判断字符串长度、是否只包含特定字符等功能，用于判断字段合法性。

7. `utils.hpp`, `utils.cpp`

    实现了程序需要的其他工具函数（包括 `std::array` 和 `std::string` 的相互转换、查询系统时间、解析命令参数等函数）。

8. `code.cpp`

    主程序，包含指令解析模块和指令执行模块。

## 功能设计

1. 文件读写系统

    文件读写系统由 `MemoryRiver`，`HashMemoryRiver` 和 `HashMap` 三个模板类构成。
    
    `MemoryRiver` 是线性文件存储类，使用整型键值查询文件内容；
    
    `HashMap` 是文件存储的哈希表，使用固定数量的哈希桶，每个桶下挂无序块状链表。
    
    - 插入元素时，先根据键值的哈希值找到对应链表，再在链表尾部块中插入元素。若尾块已满，则创建新块。

    - 删除元素时，先根据键值的哈希值找到对应链表，随后遍历该链表，找到该元素并删除。

    - 查找元素时，先根据键值的哈希值找到对应链表，随后遍历该链表，找到该元素即可。

    `HashMemoryRiver` 是 `HashMap` 专用的文件读写类。由于 `HashMemoryRiver` 含有哈希桶与数据块两种不同的类型需要存储，如果使用普通 `MemoryRiver`，则需要两个文件。`HashMemoryRiver` 重新设计了存储寻址方式，使得哈希桶和数据块可以存储在同一个文件中。

2. 账户及其管理系统

    账户系统包括账户类型 `Account` 和账户管理系统 `AccountManager`。

    `Account` 类型包含以下字段：

    - 用户ID，长度为 30 的字符数组；

    - 用户名，长度为 30 的字符数组；

    - 密码，长度为 30 的字符数组；

    - 权限等级，整型。

    `Account` 类型包含以下函数：

    - 验证密码：参数为密码字符串，返回验证是否成功的布尔值。

    `AccountManager` 类型包含以下数据成员：

    - 用户ID到用户信息的映射，哈希表；

    - 登录栈，`std::vector<Account>`；

    - 选定书籍栈，`std::vector<int>`，其存储的值为选定的书的ID，后续在图书系统中将会详细提及。

    `AccountManager` 包含以下函数：

    - 登录，参数为用户ID和密码，返回登录是否成功的布尔值，若登录成功将会把当前用户压入登录栈。

    - 注销，无参数，返回注销是否成功的布尔值，若注销成功将会把当前用户弹出登录栈。

    - 注册，参数为用户ID，用户名和密码，返回注册是否成功的布尔值。

    - 修改密码，参数为用户ID，新密码和旧密码，返回修改密码是否成功的布尔值。

    - 添加账户，参数为用户ID，用户名，密码和权限等级返回添加账户是否成功的布尔值。

    - 删除账户，参数为用户ID，返回删除账户是否成功的布尔值。

    - 查询当前用户的用户ID。

    - 查询当前用户的用户名。

    - 查询当前用户选定的书籍。

3. 书籍及其管理系统

    书籍系统包括书籍类型 `Book` 和书籍管理系统 `BookManager`。

    `Book` 类型包括以下字段：

    - ISBN，长度为 20 的字符数组；

    - 书名，长度为 60 的字符数组；

    - 作者名，长度为 60 的字符数组；

    - 关键词，长度为 60 的字符数组；

    - 价格，实型；

    - 库存量，整型；

    - 书籍ID，整型。

    `BookManager` 类型包含以下数据成员：

    - ISBN到书籍ID的映射，哈希表；

    - 书名到书籍ID的映射，哈希表；

    - 作者名到书籍ID的映射，哈希表；

    - （单个）关键词到书籍ID的映射，哈希表；

    - 按书籍ID线性存储书籍的文件。

    `BookManager` 包含以下函数：

    - 查询书库大小，返回值为整型。

    - 按ID检索书籍，返回值为 `Book` 类型。

    - 按 ISBN / 书名 / 作者 / 关键字检索书籍，返回值为 `std::vector<Book>`。

    - 序列化，返回存有所有书籍信息的 `std::vector<Book>`。

    - 加入图书，参数为 `Book` ，将会自动分配合适的书籍ID。

    - 修改图书 ISBN / 书名 / 作者 / 关键字。

    - 进货，参数为图书 ISBN 与进货量，返回进货是否成功的布尔值。

    - 购买，参数为图书 ISBN 与购买量，返回购买是否成功的布尔值。

    - 查询某个 ISBN 在书库中是否存在。

4. 日志及其管理系统

    日志系统包含财务日志类型 `FinanceLog`，员工日志类型 `EmployeeLog` ，普通日志类型 `Log` 和日志管理系统 `LogManager`。

    `FinanceLog` 类型包括以下字段：

    - 日志编号，整型；

    - 收支情况，实型。

    `EmployeeLog` 类型包括以下字段：

    - 用户ID，长度为 30 的字符数组；

    - 日志文本，长度为 200 的字符数组。

    `Log` 类型包括以下字段：

    - 日志文本，长度为 200 的字符数组。

    `LogManager` 类型包含以下数据成员：

    - 按编号顺序存储财务日志的文件；

    - 用户ID到员工日志的映射，哈希表；

    - 按编号顺序存储普通日志的文件。

    `LogManager` 类型包含以下函数：

    - 添加财务日志，参数为代表收支情况的实型数；

    - 添加员工日志，参数为员工的用户ID和日志文本；

    - 添加普通日志，参数为日志文本；

    - 查询财务情况，参数为查询的条数，返回收入与支出的数额；

    - 查询财务日志数量；

    - 生成财务报表；

    - 生成员工工作报表；

    - 打印日志。

5. 字符串验证模块

    字符串验证模块由 `Validator` 类完成，支持链式调用。

    `Validator` 类包括以下数据成员：

    - 待验证字符串；

    - 验证是否通过的布尔值。

    `Validator` 类包含以下函数：

    - 限制最大 / 最小长度；

    - 仅含可见字符；

    - 仅含字母、数字、下划线；

    - 仅含数字和小数点；

    - 仅含数字；

    - 仅含最多一个小数点；

    - 不含引号；

    - 不含竖杠。

6. 指令解析模块与主程序

    指令解析模块与主程序被集成在同一份代码中；

    指令解析与运行按一下流程进行：先读入一整行，按空格拆分为多个词法单元。按照第一个词法单元选择进入的指令。进入指令后，先判断剩余的词法单元数目是否合法；再根据指令类型把各个词法单元同指令参数进行对应；随后使用 `Validator` 类验证各参数是否合法；最后根据参数执行语句。
